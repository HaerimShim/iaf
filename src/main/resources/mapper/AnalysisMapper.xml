<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.iaf.mapper.AnalysisMapper">

    <select id="selectClientList" resultType="Client">
        SELECT client_id, client_name, status
        FROM CLIENT
        WHERE status = 'ACTIVE'
        ORDER BY client_name
    </select>

    <select id="selectCategoryListByClientId" parameterType="Long" resultType="String">
        SELECT DISTINCT category
        FROM SKU
        WHERE category IS NOT NULL
          AND client_id = #{clientId}
        ORDER BY category
    </select>

    <delete id="deleteAnalysisResultByBaseDate">
        DELETE FROM ANALYSIS_RESULT
        WHERE base_date = #{baseDate}
    </delete>

    <insert id="insertAnalysisResult">
        INSERT INTO ANALYSIS_RESULT (
            base_date, client_id, category, sku_code, sku_name,
            available_qty, avg_daily_outbound_recent7days, avg_daily_outbound_recent28days,
            estimated_sold_out_date_recent7days, estimated_sold_out_date_recent28days,
            days_remaining, status, recommendation
        )
        SELECT
            #{baseDate},
            t.client_id,
            t.category,
            t.sku_code,
            t.sku_name,
            t.available_qty,
            t.avg_daily_outbound_recent7days,
            t.avg_daily_outbound_recent28days,
            CASE
                WHEN t.avg_daily_outbound_recent7days > 0
                THEN DATE_ADD(#{baseDate}, INTERVAL FLOOR(t.available_qty / t.avg_daily_outbound_recent7days) DAY)
                ELSE NULL
            END,
            CASE
                WHEN t.avg_daily_outbound_recent28days > 0
                THEN DATE_ADD(#{baseDate}, INTERVAL FLOOR(t.available_qty / t.avg_daily_outbound_recent28days) DAY)
                ELSE NULL
            END,
            t.days_remaining,
            CASE
                WHEN t.days_remaining &lt;= 7  THEN 'DANGER'
                WHEN t.days_remaining &lt;= 14 THEN 'WARNING'
                ELSE 'SAFE'
            END,
            CASE
                WHEN t.days_remaining &lt;= 7  THEN '긴급 입고 필요'
                WHEN t.days_remaining &lt;= 14 THEN '입고 검토 필요'
                ELSE '적정 재고'
            END
        FROM (
            SELECT
                s.client_id,
                s.category,
                s.sku_code,
                s.sku_name,
                (snap.on_hand_qty - COALESCE(snap.reserved_qty, 0)) AS available_qty,
                ROUND(COALESCE(outb7.outbound_qty, 0)  / 7.0,  2) AS avg_daily_outbound_recent7days,
                ROUND(COALESCE(outb28.outbound_qty, 0) / 28.0, 2) AS avg_daily_outbound_recent28days,
                CASE
                    WHEN GREATEST(COALESCE(outb7.outbound_qty, 0), COALESCE(outb28.outbound_qty, 0)) = 0 THEN 9999
                    ELSE FLOOR((snap.on_hand_qty - COALESCE(snap.reserved_qty, 0)) / GREATEST(
                        COALESCE(outb7.outbound_qty, 0) / 7.0,
                        COALESCE(outb28.outbound_qty, 0) / 28.0
                    ))
                END AS days_remaining
            FROM SKU s
            INNER JOIN INVENTORY_SNAPSHOT snap
                ON s.sku_id = snap.sku_id AND snap.snapshot_date = #{baseDate}
            LEFT JOIN (
                SELECT sku_id, SUM(outbound_qty) AS outbound_qty
                FROM OUTBOUND_TXN
                WHERE outbound_dt BETWEEN DATE_SUB(#{baseDate}, INTERVAL 7 DAY) AND #{baseDate}
                GROUP BY sku_id
            ) outb7 ON s.sku_id = outb7.sku_id
            LEFT JOIN (
                SELECT sku_id, SUM(outbound_qty) AS outbound_qty
                FROM OUTBOUND_TXN
                WHERE outbound_dt BETWEEN DATE_SUB(#{baseDate}, INTERVAL 28 DAY) AND #{baseDate}
                GROUP BY sku_id
            ) outb28 ON s.sku_id = outb28.sku_id
            INNER JOIN CLIENT c ON s.client_id = c.client_id AND c.status = 'ACTIVE'
        ) t
    </insert>

    <select id="selectAnalysisResult" parameterType="AnalysisSearchParam" resultType="AnalysisResult">
        SELECT
            client_id,
            base_date,
            category,
            sku_code,
            sku_name,
            available_qty,
            avg_daily_outbound_recent7days,
            avg_daily_outbound_recent28days,
            COALESCE(DATE_FORMAT(estimated_sold_out_date_recent7days, '%Y-%m-%d'), '-') AS estimated_sold_out_date_recent7days,
            COALESCE(DATE_FORMAT(estimated_sold_out_date_recent28days, '%Y-%m-%d'), '-') AS estimated_sold_out_date_recent28days,
            days_remaining,
            status,
            recommendation
        FROM ANALYSIS_RESULT
        WHERE base_date = #{baseDate}
        <if test="clientId != null">
            AND client_id = #{clientId}
        </if>
        <if test="category != null and category != ''">
            AND category = #{category}
        </if>
        <if test="statusFilter != null and statusFilter != ''">
            AND status = #{statusFilter}
        </if>
        ORDER BY category, sku_code
    </select>

</mapper>
