<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.iaf.mapper.BatchLogMapper">

    <insert id="insertBatchLog" parameterType="BatchLog">
        INSERT INTO BATCH_LOG (batch_name, base_date, status, insert_count, elapsed_ms, error_message)
        VALUES (#{batchName}, #{baseDate}, #{status}, #{insertCount}, #{elapsedMs}, #{errorMessage})
    </insert>

    <select id="existsSuccessBatchLog" resultType="boolean">
        SELECT COUNT(*) > 0
        FROM BATCH_LOG
        WHERE batch_name = #{batchName}
          AND base_date = #{baseDate}
          AND status = 'SUCCESS'
    </select>


    <sql id="batchLogWhere">
        WHERE 1=1
        <if test="baseDateFrom != null and baseDateFrom != ''">
            AND base_date >= #{baseDateFrom}
        </if>
        <if test="baseDateTo != null and baseDateTo != ''">
            AND base_date &lt;= #{baseDateTo}
        </if>
        <if test="batchName != null and batchName != ''">
            AND batch_name = #{batchName}
        </if>
        <if test="status != null and status != ''">
            AND status = #{status}
        </if>
    </sql>

    <select id="countBatchLog" parameterType="SearchParam" resultType="int">
        SELECT COUNT(*)
        FROM BATCH_LOG
        <include refid="batchLogWhere"/>
    </select>

    <select id="selectBatchLog" parameterType="SearchParam" resultType="BatchLog">
        SELECT batch_log_id, batch_name, base_date, status, insert_count, elapsed_ms, error_message, created_at
        FROM BATCH_LOG
        <include refid="batchLogWhere"/>
        ORDER BY created_at DESC
        LIMIT #{pageSize} OFFSET #{offset}
    </select>

</mapper>
